# è¯„ä¼°å™¨ç½‘ç»œï¼ˆScorer Networkï¼‰ä½¿ç”¨è¯´æ˜

## ä¸€ã€æ–‡ä»¶ç»“æ„

å·²åˆ›å»ºçš„æ–‡ä»¶ï¼š

```
projects/
â”œâ”€â”€ ocnn/models/scorer_net.py      # è¯„ä¼°å™¨ç½‘ç»œæ¨¡å‹
â”œâ”€â”€ scorer_solver.py               # è®­ç»ƒå™¨
â”œâ”€â”€ configs/scorer_deepmill.yaml   # é…ç½®æ–‡ä»¶
â”œâ”€â”€ run_scorer_deepmill.py         # å¯åŠ¨è„šæœ¬
â””â”€â”€ test_scorer_network.py         # æµ‹è¯•è„šæœ¬
```

---

## äºŒã€å¿«é€Ÿå¼€å§‹

### 2.1 æµ‹è¯•ç¯å¢ƒ

```bash
cd /home/xinguanze/project/ex_6_scorer/DM-scorer/projects

# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_scorer_network.py
```

**æœŸæœ›è¾“å‡º**ï¼š
```
================================================================================
è¯„ä¼°å™¨ç½‘ç»œï¼ˆScorer Networkï¼‰æ•°æ®æµæµ‹è¯•
================================================================================

[1] æµ‹è¯•æ¨¡å‹åˆ›å»º...
   âœ“ ScorerNet æ¨¡å‹åˆ›å»ºæˆåŠŸ
   æ€»å‚æ•°é‡: 12,345,678
   å¯è®­ç»ƒå‚æ•°: 12,345,678

[2] æµ‹è¯•å‰å‘ä¼ æ’­...
   âœ“ è¾“å…¥ç‰¹å¾å½¢çŠ¶: torch.Size([2200, 4])
   âœ“ Query pointså½¢çŠ¶: torch.Size([2048, 4])
   âœ“ æ—‹è½¬çŸ©é˜µå½¢çŠ¶: torch.Size([2, 3, 3])
   âœ“ åˆ€å…·å‚æ•°å½¢çŠ¶: torch.Size([2, 4])
   âœ“ è¾“å‡ºåˆ†æ•°å½¢çŠ¶: torch.Size([2])
   âœ“ åˆ†æ•°èŒƒå›´: [-0.5234, 0.8765]

[3] æµ‹è¯•æ•°æ®åŠ è½½å™¨...
   âœ“ æ•°æ®é›†å¤§å°: 5
   âœ“ æ ·æœ¬å­—æ®µ: ['points', 'inbox_mask', 'octree', 'label', 'filename', 'rotation_matrices', 'labels', 'tool_params']
   âœ“ rotation_matrices å½¢çŠ¶: torch.Size([338, 3, 3])
   âœ“ labels å½¢çŠ¶: torch.Size([338])
   âœ“ Batch å­—æ®µ: ['points', 'inbox_mask', 'octree', 'label', 'filename', 'rotation_matrices', 'labels', 'tool_params']
   âœ“ Batch labels å½¢çŠ¶: torch.Size([2, 338])
   âœ“ Batch rotation_matrices å½¢çŠ¶: torch.Size([338, 3, 3])

[4] æµ‹è¯• ScorerSolver...
   âœ“ ScorerSolver å¯¼å…¥æˆåŠŸ
   âœ“ é‡‡æ ·æ—‹è½¬ç´¢å¼•: [123, 45, 267, 189, 12, 334, 98, 201]
   âœ“ GTåˆ†æ•°å½¢çŠ¶: torch.Size([8])

================================================================================
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è¯„ä¼°å™¨ç½‘ç»œå‡†å¤‡å°±ç»ª
================================================================================
```

---

### 2.2 å¿«é€Ÿè®­ç»ƒæµ‹è¯•ï¼ˆ1%æ•°æ®ï¼‰

```bash
cd /home/xinguanze/project/ex_6_scorer/DM-scorer/projects

# ä½¿ç”¨1%æ•°æ®å¿«é€Ÿæµ‹è¯•
python run_scorer_deepmill.py \
    --alias scorer_debug \
    --gpu 0 \
    --ratios 0.01
```

**è®­ç»ƒæ—¶é—´**: çº¦ 5-10 åˆ†é’Ÿï¼ˆå–å†³äºGPUï¼‰

---

### 2.3 å®Œæ•´è®­ç»ƒ

```bash
cd /home/xinguanze/project/ex_6_scorer/DM-scorer/projects

# ä½¿ç”¨å®Œæ•´æ•°æ®é›†è®­ç»ƒ
python run_scorer_deepmill.py --alias scorer_baseline --gpu 0 --ratios 1.0
```

**è®­ç»ƒæ—¶é—´**: çº¦ 4-8 å°æ—¶ï¼ˆå–å†³äºGPUï¼‰

---

## ä¸‰ã€å‚æ•°è¯´æ˜

### 3.1 å‘½ä»¤è¡Œå‚æ•°

```bash
python run_scorer_deepmill.py \
    --alias scorer_baseline \    # æ—¥å¿—åˆ«å
    --gpu 0 \                     # GPUè®¾å¤‡ID
    --depth 5 \                   # Octreeæ·±åº¦
    --ratios 1.0 \                # è®­ç»ƒæ•°æ®æ¯”ä¾‹ï¼ˆ0.01-1.0ï¼‰
    --ckpt path/to/ckpt.pth       # ä»æ£€æŸ¥ç‚¹æ¢å¤ï¼ˆå¯é€‰ï¼‰
```

### 3.2 é…ç½®æ–‡ä»¶å‚æ•°

**æ–‡ä»¶**: `configs/scorer_deepmill.yaml`

```yaml
SOLVER:
  type: adam              # ä¼˜åŒ–å™¨ï¼šadam / sgd
  lr: 0.001               # å­¦ä¹ ç‡
  weight_decay: 0.0001    # æƒé‡è¡°å‡
  best_val: min:test/mae  # æœ€ä¼˜æ¨¡å‹é€‰æ‹©æŒ‡æ ‡

MODEL:
  geo_channels: 256       # å‡ ä½•ç‰¹å¾ç»´åº¦
  rot_channels: 128       # æ—‹è½¬ç‰¹å¾ç»´åº¦
  tool_channels: 64       # åˆ€å…·ç‰¹å¾ç»´åº¦

DATA:
  train:
    batch_size: 8         # è®­ç»ƒæ‰¹æ¬¡å¤§å°
    distort: True         # æ•°æ®å¢å¼º
  test:
    batch_size: 1         # æµ‹è¯•æ‰¹æ¬¡å¤§å°
    distort: False        # ä¸å¢å¼º
```

---

## å››ã€è®­ç»ƒç›‘æ§

### 4.1 TensorBoard

```bash
# å¯åŠ¨TensorBoard
tensorboard --logdir=projects/logs/scorer_deepmill/scorer_baseline

# åœ¨æµè§ˆå™¨æ‰“å¼€
http://localhost:6006
```

### 4.2 å…³é”®æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­ç›‘æ§çš„æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | æœŸæœ›å€¼ |
|------|------|--------|
| **train/loss** | è®­ç»ƒæŸå¤±ï¼ˆMSEï¼‰ | é€æ¸ä¸‹é™ |
| **train/mae** | è®­ç»ƒå¹³å‡ç»å¯¹è¯¯å·® | é€æ¸ä¸‹é™ |
| **train/rmse** | è®­ç»ƒå‡æ–¹æ ¹è¯¯å·® | é€æ¸ä¸‹é™ |
| **train/rel_error** | è®­ç»ƒç›¸å¯¹è¯¯å·®ï¼ˆ%ï¼‰ | é€æ¸ä¸‹é™ |
| **test/loss** | æµ‹è¯•æŸå¤± | é€æ¸ä¸‹é™ |
| **test/mae** | æµ‹è¯•MAE | < 0.1ï¼ˆä¼˜ç§€ï¼‰ |
| **test/rmse** | æµ‹è¯•RMSE | < 0.15ï¼ˆä¼˜ç§€ï¼‰ |
| **test/rel_error** | æµ‹è¯•ç›¸å¯¹è¯¯å·® | < 10%ï¼ˆä¼˜ç§€ï¼‰ |

### 4.3 æ—¥å¿—æ–‡ä»¶

```
logs/scorer_deepmill/scorer_baseline/
â”œâ”€â”€ models_models/
â”‚   â””â”€â”€ ratio_1.00/
â”‚       â”œâ”€â”€ checkpoints/
â”‚       â”‚   â”œâ”€â”€ model_best.pth        # æœ€ä¼˜æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ model_latest.pth      # æœ€æ–°æ¨¡å‹
â”‚       â”‚   â””â”€â”€ model_*.pth           # ä¸­é—´æ£€æŸ¥ç‚¹
â”‚       â”œâ”€â”€ log.csv                   # è®­ç»ƒæ—¥å¿—
â”‚       â”œâ”€â”€ all_configs.yaml          # å®Œæ•´é…ç½®
â”‚       â””â”€â”€ events.out.tfevents.*     # TensorBoardæ—¥å¿—
â””â”€â”€ summaries.csv                     # è®­ç»ƒæ€»ç»“
```

---

## äº”ã€æ¨¡å‹æ¨ç†

### 5.1 åŠ è½½æ¨¡å‹

```python
import torch
from scorer_solver import ScorerSolver

# åŠ è½½æ£€æŸ¥ç‚¹
checkpoint_path = 'logs/scorer_deepmill/scorer_baseline/models_models/ratio_1.00/checkpoints/model_best.pth'
checkpoint = torch.load(checkpoint_path)

# é‡å»ºæ¨¡å‹
model = ScorerSolver.get_model(checkpoint['FLAGS'].MODEL)
model.load_state_dict(checkpoint['model'])
model.cuda()
model.eval()
```

### 5.2 è¯„ä¼°å•ä¸ªæ¨¡å‹çš„æ‰€æœ‰å§¿æ€

```python
import numpy as np

# å‡†å¤‡è¾“å…¥
# octree, points, tool_params ä»æ•°æ®é›†è·å–
rotation_matrices = torch.load('rotation_matrices.pth')  # [338, 3, 3]

# è¯„ä¼°æ‰€æœ‰338ä¸ªå§¿æ€
all_scores = []
with torch.no_grad():
    for i in range(338):
        rot = rotation_matrices[i:i+1]  # [1, 3, 3]
        score = model(data, octree, depth, query_pts, rot, tool_params)
        all_scores.append(score.item())

all_scores = np.array(all_scores)  # [338]

# æ‰¾åˆ°æœ€ä¼˜å§¿æ€
best_idx = all_scores.argmin()
best_score = all_scores[best_idx]
best_rotation = rotation_matrices[best_idx]

print(f"æœ€ä¼˜å§¿æ€ç´¢å¼•: {best_idx}")
print(f"æœ€ä¼˜åˆ†æ•°: {best_score:.4f}")
print(f"æœ€ä¼˜æ—‹è½¬çŸ©é˜µ:\n{best_rotation}")
```

### 5.3 æ‰¹é‡è¯„ä¼°

```python
# å¯¹æ•´ä¸ªæµ‹è¯•é›†è¯„ä¼°
from torch.utils.data import DataLoader

test_loader = ...  # åˆ›å»ºæµ‹è¯•DataLoader

results = {}
with torch.no_grad():
    for batch in test_loader:
        batch = process_batch(batch)
        
        # å¯¹æ¯ä¸ªæ ·æœ¬è¯„ä¼°æ‰€æœ‰å§¿æ€
        for rot_idx in range(338):
            rot_indices = torch.full((batch_size,), rot_idx)
            scores = model_forward(batch, rot_indices)
            # ä¿å­˜ç»“æœ
```

---

## å…­ã€è®­ç»ƒæŠ€å·§

### 6.1 å­¦ä¹ ç‡è°ƒæ•´

å¦‚æœè®­ç»ƒä¸æ”¶æ•›ï¼Œå°è¯•è°ƒæ•´å­¦ä¹ ç‡ï¼š

```yaml
# configs/scorer_deepmill.yaml
SOLVER:
  lr: 0.0001              # é™ä½å­¦ä¹ ç‡
  milestones: (120, 200)  # è°ƒæ•´å­¦ä¹ ç‡è¡°å‡æ—¶æœº
```

### 6.2 æ‰¹æ¬¡å¤§å°

æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´ï¼š

```yaml
DATA:
  train:
    batch_size: 16  # æ˜¾å­˜å……è¶³æ—¶å¢å¤§
    # æˆ–
    batch_size: 4   # æ˜¾å­˜ä¸è¶³æ—¶å‡å°
```

### 6.3 æ•°æ®å¢å¼º

```yaml
DATA:
  train:
    distort: True
    angle: (0, 10, 0)  # å¢å¤§æ—‹è½¬è§’åº¦
    scale: 0.5         # å¢å¤§ç¼©æ”¾èŒƒå›´
```

### 6.4 æŸå¤±å‡½æ•°

å¦‚æœæ•°æ®æœ‰outlierï¼Œä½¿ç”¨Huber lossï¼š

```python
# scorer_solver.py ä¸­ä¿®æ”¹
loss = self.loss_function_huber(score_pred, score_gt, delta=1.0)
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: CUDA out of memory

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# å‡å°batch_size
DATA:
  train:
    batch_size: 4  # æˆ–æ›´å°
```

### Q2: è®­ç»ƒlossä¸ä¸‹é™

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å­¦ä¹ ç‡æ˜¯å¦å¤ªå¤§æˆ–å¤ªå°
2. æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½ï¼ˆrotation_matrices, labelsï¼‰
3. æ£€æŸ¥æ¨¡å‹è¾“å‡ºèŒƒå›´æ˜¯å¦åˆç†
4. å°è¯•æ›´ç®€å•çš„æ¨¡å‹é…ç½®

```yaml
MODEL:
  geo_channels: 128   # å‡å°ç‰¹å¾ç»´åº¦
  rot_channels: 64
  tool_channels: 32
```

### Q3: æµ‹è¯•æŒ‡æ ‡ä¸ç†æƒ³

**æ”¹è¿›æ–¹å‘**:
1. å¢åŠ è®­ç»ƒæ•°æ®ï¼ˆratios=1.0ï¼‰
2. å¢å¼ºæ•°æ®å¢å¼º
3. è°ƒæ•´ç½‘ç»œæ¶æ„ï¼ˆå¢åŠ å±‚æ•°æˆ–ç»´åº¦ï¼‰
4. å°è¯•ä¸åŒçš„æŸå¤±å‡½æ•°
5. å¢åŠ è®­ç»ƒepochæ•°

### Q4: å¦‚ä½•æ¢å¤è®­ç»ƒ

```bash
python run_scorer_deepmill.py \
    --alias scorer_baseline \
    --gpu 0 \
    --ckpt logs/.../checkpoints/model_latest.pth
```

---

## å…«ã€é«˜çº§åŠŸèƒ½

### 8.1 è‡ªå®šä¹‰é‡‡æ ·ç­–ç•¥

åœ¨ `scorer_solver.py` ä¸­ä¿®æ”¹ `sample_rotation_indices` æ–¹æ³•ï¼š

```python
def sample_rotation_indices(self, B, strategy='uniform'):
    if strategy == 'weighted':
        # æ ¹æ®GTåˆ†æ•°åŠ æƒé‡‡æ ·ï¼ˆæ›´å…³æ³¨å›°éš¾æ ·æœ¬ï¼‰
        # å®ç°è‡ªå®šä¹‰é€»è¾‘
        pass
```

### 8.2 å¤šä»»åŠ¡å­¦ä¹ 

æ‰©å±•ç½‘ç»œåŒæ—¶é¢„æµ‹å¤šä¸ªç›®æ ‡ï¼š

```python
# scorer_net.py ä¸­ä¿®æ”¹è¾“å‡ºå¤´
self.score_head = nn.Linear(128, 1)      # åˆ†æ•°
self.quality_head = nn.Linear(128, 3)    # è´¨é‡åˆ†ç±»
self.roughness_head = nn.Linear(128, 1)  # è¡¨é¢ç²—ç³™åº¦
```

### 8.3 é›†æˆå­¦ä¹ 

è®­ç»ƒå¤šä¸ªæ¨¡å‹å¹¶ensembleï¼š

```bash
# è®­ç»ƒ3ä¸ªä¸åŒåˆå§‹åŒ–çš„æ¨¡å‹
python run_scorer_deepmill.py --alias scorer_v1 --gpu 0
python run_scorer_deepmill.py --alias scorer_v2 --gpu 0
python run_scorer_deepmill.py --alias scorer_v3 --gpu 0

# æ¨ç†æ—¶å¹³å‡é¢„æµ‹
scores = (model1(x) + model2(x) + model3(x)) / 3
```

---

## ä¹ã€å¯¹æ¯”ï¼šå§¿æ€é¢„æµ‹ vs è¯„ä¼°å™¨

| ç»´åº¦ | å§¿æ€é¢„æµ‹ç½‘ç»œ | è¯„ä¼°å™¨ç½‘ç»œ |
|------|-------------|-----------|
| **è¾“å…¥** | ç‚¹äº‘ + åˆ€å…· | ç‚¹äº‘ + **å§¿æ€** + åˆ€å…· |
| **è¾“å‡º** | 2ä¸ªè§’åº¦ [pitch, roll] | 1ä¸ªåˆ†æ•° |
| **è®­ç»ƒæ–‡ä»¶** | `segmentation.py` | `scorer_solver.py` |
| **é…ç½®æ–‡ä»¶** | `seg_deepmill.yaml` | `scorer_deepmill.yaml` |
| **å¯åŠ¨è„šæœ¬** | `run_seg_deepmill.py` | `run_scorer_deepmill.py` |
| **æ¨¡å‹æ–‡ä»¶** | `unet.py` | `scorer_net.py` |
| **è®­ç»ƒç­–ç•¥** | è½¯åˆ†é…loss | éšæœºé‡‡æ · + MSE |
| **æ¨ç†æ–¹å¼** | 1æ¬¡forward | 338æ¬¡forward |
| **åº”ç”¨åœºæ™¯** | é¢„æµ‹æœ€ä¼˜å§¿æ€ | è¯„ä¼°ç»™å®šå§¿æ€è´¨é‡ |

---

## åã€æ€§èƒ½åŸºå‡†

### 10.1 ç¡¬ä»¶è¦æ±‚

| é¡¹ç›® | æœ€ä½é…ç½® | æ¨èé…ç½® |
|------|---------|---------|
| GPU | GTX 1080 (8GB) | RTX 3090 (24GB) |
| CPU | 4æ ¸ | 8æ ¸ä»¥ä¸Š |
| å†…å­˜ | 16GB | 32GB |
| ç£ç›˜ | 50GB | 100GB SSD |

### 10.2 æ€§èƒ½æŒ‡æ ‡

åŸºäº RTX 3090ï¼š

| ä»»åŠ¡ | æ—¶é—´ |
|------|------|
| æ¨¡å‹åˆå§‹åŒ– | ~2ç§’ |
| å•ä¸ªepochï¼ˆå…¨æ•°æ®ï¼‰ | ~8åˆ†é’Ÿ |
| å®Œæ•´è®­ç»ƒï¼ˆ300 epochsï¼‰ | ~40å°æ—¶ |
| å•æ¬¡æ¨ç†ï¼ˆ1ä¸ªæ ·æœ¬ï¼‰ | ~0.01ç§’ |
| å…¨å§¿æ€è¯„ä¼°ï¼ˆ338ä¸ªï¼‰ | ~3ç§’ |

---

## åä¸€ã€æ€»ç»“

### âœ… å·²å®Œæˆ

1. âœ… åˆ›å»º `scorer_net.py` - è¯„ä¼°å™¨æ¨¡å‹
2. âœ… åˆ›å»º `scorer_solver.py` - è®­ç»ƒå™¨
3. âœ… åˆ›å»º `scorer_deepmill.yaml` - é…ç½®æ–‡ä»¶
4. âœ… åˆ›å»º `run_scorer_deepmill.py` - å¯åŠ¨è„šæœ¬
5. âœ… åˆ›å»º `test_scorer_network.py` - æµ‹è¯•è„šæœ¬

### ğŸ¯ ä½¿ç”¨æµç¨‹

```bash
# 1. æµ‹è¯•ç¯å¢ƒ
cd projects
python test_scorer_network.py

# 2. å¿«é€Ÿæµ‹è¯•ï¼ˆ1%æ•°æ®ï¼‰
python run_scorer_deepmill.py --gpu 0 --ratios 0.01

# 3. å®Œæ•´è®­ç»ƒ
python run_scorer_deepmill.py --gpu 0 --ratios 1.0

# 4. ç›‘æ§è®­ç»ƒ
tensorboard --logdir=logs/scorer_deepmill

# 5. æ¨ç†è¯„ä¼°
python inference_scorer.py  # æ ¹æ®éœ€è¦ç¼–å†™
```

### ğŸ“ ä¸‹ä¸€æ­¥

1. è¿è¡Œæµ‹è¯•è„šæœ¬ç¡®è®¤ç¯å¢ƒæ­£ç¡®
2. ä½¿ç”¨å°æ•°æ®é›†éªŒè¯è®­ç»ƒæµç¨‹
3. å®Œæ•´è®­ç»ƒå¹¶è°ƒä¼˜è¶…å‚æ•°
4. è¯„ä¼°æ¨¡å‹æ€§èƒ½
5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-06  
**ä½œè€…**: AI Assistant

